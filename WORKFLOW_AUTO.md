# 自动工作流 v2.0

> 最后更新: 2026-02-25
> 核心原则：文件是唯一真相，session 上下文随时会丢

---

## 一、压缩前存档（Memory Flush）

**触发**：系统提示 "Pre-compaction memory flush"

**必须做**（不可跳过，不可被新消息打断）：
1. 把当前正在做的事、进度、关键发现写入 `memory/2026-MM-DD.md`
2. 活跃任务状态写入 `memory/task-board.json`
3. 重要产出写入 `memory/shared/`（供其他 agent 读取）

**原则**：宁可多写，不可少写。压缩后这些就是唯一的记忆来源。

---

## 二、压缩后恢复（醒来自检）

**触发**：Context compaction / Gateway 重启 / 新 session

**强制执行，不可被新消息打断。先恢复记忆，再处理消息。**

### 第 1 步：读 4 个文件（必读，缺一不可）
```
1. memory/.abstract          → L0 索引（系统架构、agent 编制）
2. memory/2026-MM-DD.md      → 今日存档（做了什么、进度、发现）
3. memory/task-board.json    → 当前任务状态（活跃/阻塞/就绪）
4. memory/shared/            → 最近的共享记忆（ls 看最新 3 条）
```
今天的存档不存在则读昨天的。

### 第 2 步：确认状态
```
session_status  → 确认当前模型、token 用量、压缩次数
```

### 第 3 步：主动汇报（间隔 > 5 分钟时）
```
厂长，我刚经历了一次上下文压缩。已恢复记忆：
- 当前任务：[从 task-board 读取]
- 今天已完成：[从日志读取]
- 接下来要做：[从日志/task-board 读取]
```

### 第 4 步：继续工作
恢复完毕后，才处理新消息或继续之前的任务。

---

## 三、实时写入规则（防失忆的根本）

**不要等到压缩前才写，做完就写：**

| 事件 | 立即写入 |
|------|---------|
| 完成一个任务 | task-board.json + 日志 |
| 重要发现/决策 | memory/2026-MM-DD.md |
| 配置变更 | 日志 + 01_强制规则/ |
| 派发子任务 | task-board.json（activeTasks） |
| 子任务返回结果 | task-board.json + shared/ |
| 厂长的指示/批评 | memory/2026-MM-DD.md |
| 安装/部署了什么 | 日志 |

**原则：如果压缩现在发生，我能从文件恢复 90% 以上的记忆吗？如果不能，立即写入。**

---

## 四、定时任务

| 频率 | 任务 |
|------|------|
| 每 30 分钟 | 自动备份到 GitHub（launchd） |
| 每天 09:00 | 主动扫描待办（scan-todos.sh） |
| 每天 23:00 | 总结当天工作，写入日志 + 产出指标 |
| 每周日 | 扫描去重，归档过期内容 |

---

## 五、记忆断裂应急

**症状**：厂长说"你忘了？"/"又失忆了？"

**处理**：
1. 坦诚承认："刚经历了压缩，我恢复一下"
2. 执行第二节的恢复流程
3. 汇报恢复结果
4. **反思**：为什么这次信息没写入文件？补写 + 更新写入规则
